非常好的问题 👍
在 Kubernetes 中，**想通过 API 获取当前 Pod 的 owner（控制它的上层资源，例如 Deployment、ReplicaSet、Job 等）** 是一个很实用的需求，尤其是在写 **operator、sidecar 或自感知型应用** 时。

我来详细讲下👇

---

## 🧩 一、目标

从 Pod 内部访问 Kubernetes API，
得到：

```json
.metadata.ownerReferences
```

从而知道这个 Pod 是由哪个控制器创建的（比如 Deployment、Job、CronJob 等）。

---

## ⚙️ 二、前提：Pod 内访问 API Server

Pod 内可以直接访问：

```
https://kubernetes.default.svc
```

认证方式（默认）：

* 使用挂载的 `ServiceAccount` token
  （路径：`/var/run/secrets/kubernetes.io/serviceaccount/token`）
* 读取命名空间文件 `/var/run/secrets/kubernetes.io/serviceaccount/namespace`

---

## 🧠 三、完整步骤

### 1️⃣ 获取当前 Pod 名称

可以通过环境变量：

```bash
echo $HOSTNAME
```

Kubernetes 会自动把 Pod 名作为容器的 hostname。
假设结果是：

```
myapp-5d7f76bdfb-xyz
```

---

### 2️⃣ 获取命名空间

```bash
cat /var/run/secrets/kubernetes.io/serviceaccount/namespace
```

假设是：

```
default
```

---

### 3️⃣ 使用 token 访问 Kubernetes API

```bash
TOKEN=$(cat /var/run/secrets/kubernetes.io/serviceaccount/token)
NAMESPACE=$(cat /var/run/secrets/kubernetes.io/serviceaccount/namespace)
POD=$(echo $HOSTNAME)

curl -sSk \
  -H "Authorization: Bearer $TOKEN" \
  https://kubernetes.default.svc/api/v1/namespaces/$NAMESPACE/pods/$POD
```

输出中你会看到：

```json
{
  "metadata": {
    "name": "myapp-5d7f76bdfb-xyz",
    "namespace": "default",
    "ownerReferences": [
      {
        "apiVersion": "apps/v1",
        "kind": "ReplicaSet",
        "name": "myapp-5d7f76bdfb",
        "uid": "c3c124b2-4b7f-4dc2-b2ff-f1a738c42d67",
        "controller": true,
        "blockOwnerDeletion": true
      }
    ]
  }
}
```

---

### 4️⃣ 解析 owner 信息

从 `.metadata.ownerReferences[0]` 可得：

* kind = `"ReplicaSet"`
* name = `"myapp-5d7f76bdfb"`

若要继续追溯上层（如 Deployment），
可以再请求：

```bash
curl -sSk \
  -H "Authorization: Bearer $TOKEN" \
  https://kubernetes.default.svc/apis/apps/v1/namespaces/$NAMESPACE/replicasets/myapp-5d7f76bdfb
```

它的 `metadata.ownerReferences[0]` 通常是：

```json
{
  "apiVersion": "apps/v1",
  "kind": "Deployment",
  "name": "myapp"
}
```

这样就能找到最终的 **Deployment** 名称。

---

## 🧩 四、Kubernetes Go Client / Python Client 示例（更优雅）

### ✅ Kotlin / Java（使用官方 Fabric8 client）

```kotlin
val client = DefaultKubernetesClient()
val podName = System.getenv("HOSTNAME")
val namespace = File("/var/run/secrets/kubernetes.io/serviceaccount/namespace").readText().trim()
val pod = client.pods().inNamespace(namespace).withName(podName).get()
val owner = pod.metadata.ownerReferences?.firstOrNull()
println("Owner Kind: ${owner?.kind}, Name: ${owner?.name}")
```

### ✅ Python（kubernetes-client）

```python
from kubernetes import client, config
import os

config.load_incluster_config()

v1 = client.CoreV1Api()
namespace = open("/var/run/secrets/kubernetes.io/serviceaccount/namespace").read().strip()
pod_name = os.getenv("HOSTNAME")
pod = v1.read_namespaced_pod(pod_name, namespace)
owner = pod.metadata.owner_references[0]
print(f"Owner Kind: {owner.kind}, Name: {owner.name}")
```

---

## 🔐 五、安全讲究

| 安全项                    | 建议                                    |
| ---------------------- | ------------------------------------- |
| ServiceAccount 权限      | 仅授予 `get` 权限：`pods`（namespace 范围即可）   |
| 避免 `list` 或 `watch` 权限 | 防止越权访问其他 Pod 信息                       |
| 禁用自动挂载 token（不需要时）     | `automountServiceAccountToken: false` |

**示例 RBAC：**

```yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: pod-self-reader
rules:
  - apiGroups: [""]
    resources: ["pods"]
    verbs: ["get"]
---
kind: RoleBinding
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: pod-self-reader-binding
subjects:
  - kind: ServiceAccount
    name: my-sa
roleRef:
  kind: Role
  name: pod-self-reader
  apiGroup: rbac.authorization.k8s.io
```

---

## 🧮 六、总结

| 步骤 | 内容                                                   |
| -- | ---------------------------------------------------- |
| 1  | 获取 Pod 名（`$HOSTNAME`）                                |
| 2  | 获取 Namespace                                         |
| 3  | 使用 token 调用 `GET /api/v1/namespaces/{ns}/pods/{pod}` |
| 4  | 查看 `.metadata.ownerReferences`                       |
| 5  | 若需要追溯上层（ReplicaSet → Deployment）继续查询                 |
| 6  | 控制权限：仅允许 `get pods`                                  |

---

✅ **一句话总结：**

> Pod 内获取自身 Owner：
> 通过挂载的 ServiceAccount Token 访问 Kubernetes API → 获取 Pod 对象 → 读取 `.metadata.ownerReferences`。
> 权限只需 `get pods`，非常安全。

---

是否希望我帮你写一个 **最小化示例容器（bash 或 Python）**，运行后自动打印出当前 Pod 的 owner kind/name？
你可以直接放进集群里试。
