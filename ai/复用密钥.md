éå¸¸å¥½ï¼Œè¿™ä¸ªé—®é¢˜éå¸¸å…¸å‹ ğŸ‘

> ä½ æƒ³åœ¨ Helm Chart ä¸­ç”Ÿæˆä¸€ä¸ªéšæœºå¯†é’¥ï¼ˆä¾‹å¦‚ AES keyã€JWT secretã€æ•°æ®åº“å¯†ç ï¼‰ï¼Œ
> **ç¬¬ä¸€æ¬¡å®‰è£…æ—¶åˆ›å»º Secret å¹¶ä¿å­˜ä¸‹æ¥**ï¼Œ
> ä¹‹å **å‡çº§ Chart æ—¶ä¸è¦è¢«è¦†ç›–æˆ–é‡æ–°ç”Ÿæˆ**ã€‚

è¿™æ˜¯ä¸€ä¸ª **Helm æ¨¡æ¿æŒä¹…åŒ–éšæœºå€¼** çš„ç»å…¸éœ€æ±‚ã€‚

---

## âœ… ç›®æ ‡

* Chart å®‰è£…æ—¶ï¼šç”Ÿæˆéšæœºå¯†é’¥
* Chart å‡çº§æ—¶ï¼š**å¤ç”¨å·²æœ‰ Secret ä¸­çš„å¯†é’¥ï¼Œä¸å†å˜åŒ–**

---

## âœ… æ¨èæ–¹æ¡ˆï¼ˆHelm å®˜æ–¹æ¨èå†™æ³•ï¼‰

Helm æä¾›äº† `lookup` å‡½æ•°ï¼ˆHelm 3.2+ï¼‰ï¼Œ
å¯åœ¨æ¨¡æ¿ä¸­**è¯»å–é›†ç¾¤ç°æœ‰èµ„æº**ï¼Œæ¯”å¦‚ Secretã€‚

---

### ğŸ§© ç¤ºä¾‹æ¨¡æ¿ â€” `templates/secret.yaml`

```yaml
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "mychart.fullname" . }}-secret
type: Opaque
data:
  app-secret: {{- include "mychart.secret" . | nindent 4 }}
```

---

### ğŸ§© `_helpers.tpl`

```yaml
{{- define "mychart.secret" -}}
{{/*
  1ï¸âƒ£ å¦‚æœ Secret å·²å­˜åœ¨ â†’ ä»é›†ç¾¤è¯»å–
  2ï¸âƒ£ å¦åˆ™ â†’ ç”Ÿæˆæ–°éšæœºå€¼å¹¶ Base64 ç¼–ç 
*/}}

{{- $secretName := (printf "%s-secret" (include "mychart.fullname" .)) -}}
{{- $existing := (lookup "v1" "Secret" .Release.Namespace $secretName) -}}

{{- if $existing }}
  {{- index $existing.data "app-secret" }}
{{- else }}
  {{- $rand := randAlphaNum 32 | b64enc }}
  {{- $rand }}
{{- end }}
{{- end }}
```

---

### âœ… è§£é‡Š

| é€»è¾‘         | è¡Œä¸º                                       |
| ---------- | ---------------------------------------- |
| é¦–æ¬¡å®‰è£…       | Secret ä¸å­˜åœ¨ â†’ è‡ªåŠ¨ç”Ÿæˆéšæœºå­—ç¬¦ä¸²å¹¶ Base64 ç¼–ç         |
| åç»­å‡çº§       | `lookup` æ‰¾åˆ°å·²æœ‰ Secret â†’ å¤ç”¨ `app-secret` å€¼ |
| é‡æ–°å®‰è£…ï¼ˆåˆ é™¤å†è£…ï¼‰ | Secret è¢«åˆ é™¤ â†’ ä¼šé‡æ–°ç”Ÿæˆæ–°çš„å¯†é’¥                   |

---

## âœ… éªŒè¯å‘½ä»¤

```bash
# é¦–æ¬¡å®‰è£…
helm install myapp ./mychart

# æŸ¥çœ‹ secret å†…å®¹
kubectl get secret myapp-secret -o yaml

# å‡çº§ chart
helm upgrade myapp ./mychart

# æŸ¥çœ‹ secret æ˜¯å¦å˜åŒ–
kubectl get secret myapp-secret -o yaml
```

ç»“æœåº”å½“æ˜¾ç¤ºç›¸åŒçš„ `app-secret`ã€‚

---

## âœ… å¯é€‰æ‰©å±•ï¼šå¤šå¯†é’¥æ”¯æŒ

æ”¯æŒç”Ÿæˆå¤šä¸ªé”®ï¼š

```yaml
data:
  jwt-secret: {{ include "mychart.secret" (dict "root" . "key" "jwt-secret") | nindent 4 }}
  db-password: {{ include "mychart.secret" (dict "root" . "key" "db-password") | nindent 4 }}
```

å¯¹åº” `_helpers.tpl`ï¼š

```yaml
{{- define "mychart.secret" -}}
{{- $root := .root -}}
{{- $key := .key -}}
{{- $secretName := (printf "%s-secret" (include "mychart.fullname" $root)) -}}
{{- $existing := (lookup "v1" "Secret" $root.Release.Namespace $secretName) -}}
{{- if $existing }}
  {{- index $existing.data $key | default (randAlphaNum 32 | b64enc) }}
{{- else }}
  {{- randAlphaNum 32 | b64enc }}
{{- end }}
{{- end }}
```

è¿™æ ·æ¯ä¸ª key ç‹¬ç«‹ã€å¯æ‰©å±•ã€‚

---

## âœ… æ³¨æ„äº‹é¡¹

| é—®é¢˜                          | è¯´æ˜                                |
| --------------------------- | --------------------------------- |
| âŒ `randAlphaNum` æ¯æ¬¡æ¨¡æ¿æ¸²æŸ“éƒ½ä¼šå˜åŒ– | å¿…é¡»æ­é… `lookup` ä½¿ç”¨                  |
| âœ… `lookup` åªèƒ½åœ¨å®‰è£…åå­˜åœ¨èµ„æºæ—¶ä½¿ç”¨    | é¦–æ¬¡å®‰è£…æ—¶è¿”å› `nil`                     |
| âœ… Secret å¿…é¡»å‘½åå›ºå®š             | å¦åˆ™å‡çº§æ—¶æ— æ³•æ‰¾åˆ°æ—§çš„ Secret                |
| âœ… ä»…åœ¨åŒ namespace æœ‰æ•ˆ          | `lookup` æŸ¥çš„æ˜¯ `.Release.Namespace` |

---

## âœ… æ€»ç»“

| åœºæ™¯    | è§£å†³æ–¹å¼                    |
| ----- | ----------------------- |
| é¦–æ¬¡å®‰è£…  | ç”Ÿæˆéšæœºå¯†é’¥ï¼ˆ`randAlphaNum`ï¼‰  |
| å‡çº§    | ä»é›†ç¾¤ä¸­å–æ—§ Secretï¼ˆ`lookup`ï¼‰ |
| åˆ é™¤å†è£…  | æ–° Secret é‡æ–°ç”Ÿæˆ           |
| å¤šä¸ªéšæœºå€¼ | ç”¨ `dict` å‚æ•°æ”¯æŒå¤šä¸ª key     |

---

æ˜¯å¦å¸Œæœ›æˆ‘å¸®ä½ æ‰©å±•è¿™ä¸ªæ¨¡æ¿ï¼Œè®©å®ƒèƒ½ï¼š

* âœ… è‡ªåŠ¨æ”¯æŒå¤šç¯å¢ƒï¼ˆå¦‚ dev / prod å‘½åç©ºé—´åŒºåˆ†ï¼‰ï¼›
* âœ… å¹¶ä¸”ç”Ÿæˆæ—¶å¯è‡ªå®šä¹‰å¯†é’¥é•¿åº¦æˆ–å­—ç¬¦é›†ï¼Ÿ
